(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{319:function(s,t,a){"use strict";a.r(t);var n=a(14),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"高性能mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高性能mysql"}},[s._v("#")]),s._v(" 高性能mysql")]),s._v(" "),t("h2",{attrs:{id:"并发控制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#并发控制"}},[s._v("#")]),s._v(" 并发控制")]),s._v(" "),t("ul",[t("li",[s._v("读写锁")])]),s._v(" "),t("blockquote",[t("p",[s._v("读共享,写互斥")])]),s._v(" "),t("ul",[t("li",[s._v("锁粒度")])]),s._v(" "),t("blockquote",[t("p",[s._v("表锁,行锁")])]),s._v(" "),t("h2",{attrs:{id:"事务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#事务"}},[s._v("#")]),s._v(" 事务")]),s._v(" "),t("ul",[t("li",[s._v("ACID")])]),s._v(" "),t("blockquote",[t("p",[s._v("原子性,隔离性,一致性,持久性")])]),s._v(" "),t("ul",[t("li",[s._v("隔离级别")])]),s._v(" "),t("blockquote",[t("ol",[t("li",[s._v("READ UNCOMMITTED(读未提交) -- 脏读 "),t("br")]),s._v(" "),t("li",[s._v("READ COMMITTED(读已提交)  -- 不可重复读"),t("br")]),s._v(" "),t("li",[s._v("REPEATABLE READ(可重复度) -- 幻读"),t("br"),s._v("  mysql默认事务隔离级别")]),s._v(" "),t("li",[s._v("SERIALIZABLE(可串行化)  -- 读取数据每一行都加锁")])])]),s._v(" "),t("ul",[t("li",[s._v("死锁")])]),s._v(" "),t("blockquote",[t("p",[s._v("多个事务交替执行,在同一资源互相占用,互相等待, 死锁检测和死锁超时")])]),s._v(" "),t("ul",[t("li",[s._v("MVCC 多版本并发控制")])]),s._v(" "),t("blockquote",[t("p",[s._v("InnoDB 的mvcc 是通过在每行记录后面保存2个隐藏列实现的,一个保存了行的创建时间,一个保存了行的删除时间\n具体存储的内容是系统版本号(system version number),每开启一个新的事务,系统版本号就会自动递增"),t("br")])]),s._v(" "),t("p",[s._v("来看下,在REPEATABLE READ隔离级别下,mvcc具体是如何操作的:")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("SELECT")]),s._v(" "),t("ul",[t("li",[s._v("行的创建版本号<= 当前事务的版本号,可以确保事务读取的行要么是开始前就存在的,要么是当前事务插入或者修改的")]),s._v(" "),t("li",[s._v("行的删除版本号要么未定义,要么>当前事务版本号,这样可以确保事务读取的数据,在事务开始之前未被删除")])])]),s._v(" "),t("li",[t("p",[s._v("INSERT")]),s._v(" "),t("p",[s._v("InnoDB为新插入的每一行保存当前系统版本号作为行版本号")])]),s._v(" "),t("li",[t("p",[s._v("DELETE")]),s._v(" "),t("p",[s._v("InnoDB为新删除的每一行保存当前系统版本号作为行删除版本号")])]),s._v(" "),t("li",[t("p",[s._v("UPDATE")]),s._v(" "),t("p",[s._v("InnoDB为插入一行新记录,保存当前系统版本号,作为创建版本号,同时保存当前系统版本号到原来的行作为删除版本号")])])]),s._v(" "),t("p",[s._v("MVCC 只在READ COMMITTED(读已提交)和REPEATABLE READ(可重复度)两个隔离级别下工作.")]),s._v(" "),t("h2",{attrs:{id:"数据存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据存储"}},[s._v("#")]),s._v(" 数据存储")]),s._v(" "),t("p",[s._v("在mysql,文件存储目录,每新建一个数据库,会多一个数据库名称的文件夹,在该文件目录下,每一个表有\n.frm 文件保存表的定义")]),s._v(" "),t("p",[s._v("InnoDB存储引擎下:")]),s._v(" "),t("p",[s._v("（1）*.frm--表结构的文件。")]),s._v(" "),t("p",[s._v("（2）*.ibd--表数据和索引的文件。该表的索引(B+树)的每个非叶子节点存储索引，叶子节点存储索引和索引对应的数据。")]),s._v(" "),t("p",[s._v("Myisam存储引擎下:\n（1）*.frm--表定义，是描述表结构的文件。")]),s._v(" "),t("p",[s._v('（2）*.MYD--"D"数据信息文件，是表的数据文件。')]),s._v(" "),t("p",[s._v('（3）*.MYI--"I"索引信息文件，是表数据文件中任何索引的数据树')]),s._v(" "),t("p",[s._v("例如:")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@mysql1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /var/lib/mysql")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@mysql1 mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\n总用量 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110608")]),s._v("\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 01:32 auto.cnf\ndrwx------. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" mysql mysql     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 haha_test\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12582912")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":54 ibdata1\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50331648")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":54 ib_logfile0\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50331648")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 01:32 ib_logfile1\ndrwx------. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" mysql mysql     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 01:32 mysql\nsrwxrwxrwx. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":54 mysql.sock\ndrwx------. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" mysql mysql     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 01:32 performance_schema\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@mysql1 mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd haha_test/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@mysql1 haha_test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\n总用量 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("616")]),s._v("\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8906")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 customers.frm\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("98304")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 customers.ibd\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":59 db.opt\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8728")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 orderitems.frm\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114688")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 orderitems.ibd\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8648")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 orders.frm\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114688")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 orders.ibd\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8682")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 productnotes.frm\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1896")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 productnotes.MYD\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6144")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 productnotes.MYI\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8724")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 products.frm\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114688")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 products.ibd\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8818")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":05 vendors.frm\n-rw-rw----. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mysql mysql  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("98304")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":06 vendors.ibd\n")])])]),t("h2",{attrs:{id:"性能优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#性能优化"}},[s._v("#")]),s._v(" 性能优化")]),s._v(" "),t("p",[s._v("优化原则是降低响应时间,而不是说降低资源消耗,cpu,内存,利用率高并不是坏事.")]),s._v(" "),t("h3",{attrs:{id:"慢查询监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#慢查询监控"}},[s._v("#")]),s._v(" 慢查询监控")]),s._v(" "),t("p",[s._v("为了降低响应时间,必须要知道响应时间是多,这个利用mysql的慢查询日志")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 慢查询日志")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 慢查询是否开启及日志保存位置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slow_query%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# slow_query_log,OFF")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# slow_query_log_file,/var/lib/mysql/mysql1-slow.log")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 慢查询时间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'long_query_time'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启慢查询")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" slow_query_log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ON'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置日志位置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" slow_query_log_file "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/lib/mysql/mysql1-slow.log'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置慢查询时间，单位（秒）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" long_query_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里为了监控所有sql,设置慢查询时间为0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" long_query_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置参数后,要重新打开新的连接,查询才会生效")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# long_query_time,0.000000")]),s._v("\n")])])]),t("p",[s._v("测试慢sql监控")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" cust_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" orders\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" orders\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志内容  start")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1682079377")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* ApplicationName=IntelliJ IDEA 2023.1 */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" SQL_SELECT_LIMIT "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("501")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# User@Host: root[root] @  [192.168.5.1]  Id:     6")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Query_time: 0.000714  Lock_time: 0.000179 Rows_sent: 1  Rows_examined: 5")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1682079377")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* ApplicationName=IntelliJ IDEA 2023.1 */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" cust_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" orders\n                                           "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" orders"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# User@Host: root[root] @  [192.168.5.1]  Id:     6")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Query_time: 0.000111  Lock_time: 0.000000 Rows_sent: 0  Rows_examined: 0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1682079377")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WARNINGS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# User@Host: root[root] @  [192.168.5.1]  Id:     6")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Query_time: 0.000155  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1682079377")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@session.tx_isolation")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志内容  end")]),s._v("\n\n")])])]),t("h3",{attrs:{id:"mysql-慢查询分析工具-pt-query-digest"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql-慢查询分析工具-pt-query-digest"}},[s._v("#")]),s._v(" MySQL 慢查询分析工具 pt-query-digest")]),s._v(" "),t("p",[s._v("安装")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-Digest-MD5 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" \n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-DBI "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-DBD-MySQL "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-Time-HiRes "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-IO-Socket-SSL "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" percona.com/get/pt-query-digest \n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" u+x pt-query-digest\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" pt-query-digest /usr/bin/ \n\n")])])]),t("p",[s._v("使用")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1.直接分析慢查询文件")]),s._v("\npt-query-digest  slow.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" slow_report.log\n")])])]),t("p",[s._v("结果分析")]),s._v(" "),t("ol",[t("li",[s._v("第一部分：总体统计结果")])]),s._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# 该工具执行日志分析的用户时间，系统时间，物理内存占用大小，虚拟内存占用大小\n# 340ms user time, 140ms system time, 23.99M rss, 203.11M vsz\n# 工具执行时间\n# Current date: Fri Nov 25 02:37:18 2016\n# 运行分析工具的主机名\n# Hostname: localhost.localdomain\n# 被分析的文件名\n# Files: slow.log\n# 语句总数量，唯一的语句数量，QPS，并发数\n# Overall: 2 total, 2 unique, 0.01 QPS, 0.01x concurrency ________________\n# 日志记录的时间范围\n# Time range: 2016-11-22 06:06:18 to 06:11:40\n# 属性               总计      最小    最大    平均    95%  标准    中等\n# Attribute          total     min     max     avg     95%  stddev  median\n# ============     ======= ======= ======= ======= ======= ======= =======\n# 语句执行时间\n# Exec time             3s   640ms      2s      1s      2s   999ms      1s\n# 锁占用时间\n# Lock time            1ms       0     1ms   723us     1ms     1ms   723us\n# 发送到客户端的行数\n# Rows sent              5       1       4    2.50       4    2.12    2.50\n# select语句扫描行数\n# Rows examine     186.17k       0 186.17k  93.09k 186.17k 131.64k  93.09k\n# 查询的字符数\n# Query size           455      15     440  227.50     440  300.52  227.50\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("查询分组统计结果")])]),s._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Rank：所有语句的排名，默认按查询时间降序排列，通过 --order-by 指定\n\nQuery ID：语句的 ID，（去掉多余空格和文本字符，计算 hash 值）\n\nResponse：总的响应时间\n\ntime：该查询在本次分析中总的时间占比\n\ncalls：执行次数，即本次分析总共有多少条这种类型的查询语句\n\nR/Call：平均每次执行的响应时间\n\nV/M：响应时间 Variance-to-mean 的比率\n\nItem：查询对象\n\n\n# Profile\n# Rank Query ID           Response time Calls R/Call V/M   Item\n# ==== ================== ============= ===== ====== ===== ===============\n#    1 0xF9A57DD5A41825CA  2.0529 76.2%     1 2.0529  0.00 SELECT\n#    2 0x4194D8F83F4F9365  0.6401 23.8%     1 0.6401  0.00 SELECT wx_member_base\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("每一种查询的详细统计结果")])]),s._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("由下面查询的详细统计结果，最上面的表格列出了执行次数、最大、最小、平均、95% 等各项目的统计。\n\nID：查询的 ID 号，和上图的 Query ID 对应\n\nDatabases：数据库名\n\nUsers：各个用户执行的次数（占比）\n\nQuery_time distribution ：查询时间分布，长短体现区间占比，本例中 1s-10s 之间查询数量是 10s 以上的两倍。\n\nTables：查询中涉及到的表\n\nExplain：SQL 语句\n\n\n# Query 1: 0 QPS, 0x concurrency, ID 0xF9A57DD5A41825CA at byte 802 ______\n# This item is included in the report because it matches --limit.\n# Scores: V/M = 0.00\n# Time range: all events occurred at 2016-11-22 06:11:40\n# Attribute    pct   total     min     max     avg     95%  stddev  median\n# ============ === ======= ======= ======= ======= ======= ======= =======\n# Count         50       1\n# Exec time     76      2s      2s      2s      2s      2s       0      2s\n# Lock time      0       0       0       0       0       0       0       0\n# Rows sent     20       1       1       1       1       1       0       1\n# Rows examine   0       0       0       0       0       0       0       0\n# Query size     3      15      15      15      15      15       0      15\n# String:\n# Databases    test\n# Hosts        192.168.8.1\n# Users        mysql\n# Query_time distribution\n#   1us\n#  10us\n# 100us\n#   1ms\n#  10ms\n# 100ms\n#    1s  ################################################################\n#  10s+\n# EXPLAIN /*!50100 PARTITIONS*/\nselect sleep(2)\\G\n")])])]),t("h3",{attrs:{id:"慢sql监控告警"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#慢sql监控告警"}},[s._v("#")]),s._v(" 慢sql监控告警")]),s._v(" "),t("p",[s._v("如果做到准实时的话,只能在mysql 服务器部署一个agent,实时tail mysql-slow.log 然后将结果上传至分析服务器,\n在设置一批告警和推送策略.后面我们会具体实现一个mysql 慢查询监控告警平台")]),s._v(" "),t("h2",{attrs:{id:"分析单条查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分析单条查询"}},[s._v("#")]),s._v(" 分析单条查询")]),s._v(" "),t("ul",[t("li",[s._v("show profile")])]),s._v(" "),t("blockquote",[t("p",[s._v("该命令会展示 sql每个环节消耗时间,从而利于我们去优化")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分析单条查询")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启 profile")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" profiling "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行查询")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" cust_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" orders\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" orders"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分析结果")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" profiles"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" profile "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" query "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h3",{attrs:{id:"合理使用数据类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#合理使用数据类型"}},[s._v("#")]),s._v(" 合理使用数据类型")]),s._v(" "),t("p",[s._v("如果情况允许,都设置 字段非null,默认空字符串或者0\n无符号的,去掉符号位,增大空间")]),s._v(" "),t("p",[s._v("整形(tinyint int long)"),t("br"),s._v("\n字符串(char varchar text)"),t("br"),s._v("\nchar 定长,会吃掉尾部的空格,空间连续且固定"),t("br"),s._v("\nvarchar非定长,浪费空间,且在改变长度时,会增大碎片, 原理是 字符串+字符串长度 + 预留空间"),t("br")]),s._v(" "),t("h3",{attrs:{id:"范式和反范式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#范式和反范式"}},[s._v("#")]),s._v(" 范式和反范式")]),s._v(" "),t("p",[s._v("说白了就是合理的数据冗余,避免宽表(反范式)和过多的表关联(范式)")]),s._v(" "),t("h3",{attrs:{id:"合理利用索引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#合理利用索引"}},[s._v("#")]),s._v(" 合理利用索引")]),s._v(" "),t("p",[s._v("InnoDB 模式下,索引分为两类:")]),s._v(" "),t("ul",[t("li",[s._v("hash索引 (无序高效)")]),s._v(" "),t("li",[s._v("b-tree 索引 (有序高效")])]),s._v(" "),t("p",[s._v("需要注意的是在使用b-tree索引时要注意 最左匹配,这个是复合索引 数据结构特性 要求的")]),s._v(" "),t("ul",[t("li",[s._v("索引大大减少了服务器需要扫描的数据量")]),s._v(" "),t("li",[s._v("索引可以帮助服务器避免排序和临时表")]),s._v(" "),t("li",[s._v("索引可以将随机io变为顺序io")])]),s._v(" "),t("p",[s._v("不过需要说的是,索引并不是最好的解决方案,对于数据量小的表,全表扫描反而更高效"),t("br"),s._v("\n而对于数据量特别大的表,索引的维护也会吃掉很多资源,不是那么便捷,对于中大型数据表来说最好")]),s._v(" "),t("p",[s._v("对与超大数据表,最好用表分区,或者直接分派,拆表或者拆库")]),s._v(" "),t("ul",[t("li",[s._v("怎么合理的选择列创建索引")])]),s._v(" "),t("ol",[t("li",[s._v("避免大字符串索引(索引维护很消耗资源,和redis避免大key一个道理) 如果必须 则使用前缀索引(即大字符的前固定字符串)")]),s._v(" "),t("li",[s._v("多列索引-复合索引 必须要选择合适的索引顺序")]),s._v(" "),t("li",[s._v("聚簇索引(主键索引),主键应该离散和有序,在写操作时高效")]),s._v(" "),t("li",[s._v("非聚簇索引,又称覆盖索引,注意查询列,避免回表")]),s._v(" "),t("li",[s._v("冗余和重复索引,mysql允许在一个列或者多个列重复创建索引")]),s._v(" "),t("li",[s._v("索引和锁,缩小查询行数,锁的粒度就会大大缩小,增大并发")]),s._v(" "),t("li",[s._v("索引碎片修复,避免随机io,简单做法就一个空的ALTER TABLE")])]),s._v(" "),t("h2",{attrs:{id:"查询优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查询优化"}},[s._v("#")]),s._v(" 查询优化")]),s._v(" "),t("ol",[t("li",[s._v("避免查询不需要的记录 也就是 禁止使用 select *")]),s._v(" "),t("li",[s._v("避免扫描过多的行,就是 sql执行过程中,扫描行数 应该无限 接近 返回行数")]),s._v(" "),t("li",[s._v("复杂sql拆分,直白点就是分解sql,分批次执行避免长时间 占有锁")]),s._v(" "),t("li",[s._v("show full processlist 查看连接线程状态")]),s._v(" "),t("li",[s._v("表分区/分片")])]),s._v(" "),t("h2",{attrs:{id:"mysql复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql复制"}},[s._v("#")]),s._v(" mysql复制")]),s._v(" "),t("p",[s._v("主从数据库"),t("br"),s._v(" "),t("img",{attrs:{src:"/to-be-bast/images/mysql%E5%A4%8D%E5%88%B6.png",alt:"mysql复制"}})]),s._v(" "),t("ol",[t("li",[s._v("数据多中心容灾")]),s._v(" "),t("li",[s._v("数据备份")]),s._v(" "),t("li",[s._v("读写分离")])]),s._v(" "),t("p",[s._v("过程")]),s._v(" "),t("ol",[t("li",[s._v("主库将提交事务的记录写字binlog日志中")]),s._v(" "),t("li",[s._v("从库会有一个线程网络IO读取主库的binlog日志,写在自己的relay-log日志末尾")]),s._v(" "),t("li",[s._v("从库会有一个线程读取relay-log 日志写入自己的数据库中")])]),s._v(" "),t("p",[s._v("问题")]),s._v(" "),t("ol",[t("li",[s._v("数据丢失")]),s._v(" "),t("li",[s._v("数据延迟")]),s._v(" "),t("li",[s._v("数据不一致")])]),s._v(" "),t("h2",{attrs:{id:"mysql扩展"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql扩展"}},[s._v("#")]),s._v(" mysql扩展")]),s._v(" "),t("ol",[t("li",[s._v("垂直扩展(新增设备)")]),s._v(" "),t("li",[s._v("水平扩展(单设备新增库表)")])]),s._v(" "),t("p",[s._v("数据分片,这个不好控制,如非必要尽量不要分片,如有分片需求,\n尽量做到冷热数据维度去分片")]),s._v(" "),t("p",[s._v("负载均衡\n在mysql前加一个代理或者在客户端做多数据源管理")]),s._v(" "),t("h2",{attrs:{id:"高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高可用"}},[s._v("#")]),s._v(" 高可用")]),s._v(" "),t("p",[s._v("故障恢复\n故障隔离\n故障自动切换\n数据备份")])])}),[],!1,null,null,null);t.default=e.exports}}]);