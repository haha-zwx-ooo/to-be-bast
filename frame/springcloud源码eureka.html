<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>springCloud源码分析eureka</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/to-be-bast/favicon.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?928c7c5c1127ed68793a835c728ec9be";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
        </script>
    <meta name="description" content="zwx-haha个人技术文档">
    
    <link rel="preload" href="/to-be-bast/assets/css/0.styles.be698e14.css" as="style"><link rel="preload" href="/to-be-bast/assets/js/app.c3e67182.js" as="script"><link rel="preload" href="/to-be-bast/assets/js/2.a97ad3d5.js" as="script"><link rel="preload" href="/to-be-bast/assets/js/63.e40f2c54.js" as="script"><link rel="prefetch" href="/to-be-bast/assets/js/10.c5262efb.js"><link rel="prefetch" href="/to-be-bast/assets/js/11.c59ed9e2.js"><link rel="prefetch" href="/to-be-bast/assets/js/12.9f0a73c1.js"><link rel="prefetch" href="/to-be-bast/assets/js/13.17a058af.js"><link rel="prefetch" href="/to-be-bast/assets/js/14.db6b1266.js"><link rel="prefetch" href="/to-be-bast/assets/js/15.21e0cede.js"><link rel="prefetch" href="/to-be-bast/assets/js/16.430911cf.js"><link rel="prefetch" href="/to-be-bast/assets/js/17.658f2682.js"><link rel="prefetch" href="/to-be-bast/assets/js/18.bcaa61e8.js"><link rel="prefetch" href="/to-be-bast/assets/js/19.76f74703.js"><link rel="prefetch" href="/to-be-bast/assets/js/20.b2ef81e3.js"><link rel="prefetch" href="/to-be-bast/assets/js/21.3539e5c6.js"><link rel="prefetch" href="/to-be-bast/assets/js/22.45f1fd04.js"><link rel="prefetch" href="/to-be-bast/assets/js/23.f7057a81.js"><link rel="prefetch" href="/to-be-bast/assets/js/24.871f1c42.js"><link rel="prefetch" href="/to-be-bast/assets/js/25.9dbd80cb.js"><link rel="prefetch" href="/to-be-bast/assets/js/26.813bd17d.js"><link rel="prefetch" href="/to-be-bast/assets/js/27.77edb239.js"><link rel="prefetch" href="/to-be-bast/assets/js/28.3217d365.js"><link rel="prefetch" href="/to-be-bast/assets/js/29.2969c686.js"><link rel="prefetch" href="/to-be-bast/assets/js/3.0d77f0c3.js"><link rel="prefetch" href="/to-be-bast/assets/js/30.c1e77f7b.js"><link rel="prefetch" href="/to-be-bast/assets/js/31.a2723f65.js"><link rel="prefetch" href="/to-be-bast/assets/js/32.51203b3b.js"><link rel="prefetch" href="/to-be-bast/assets/js/33.39ad8118.js"><link rel="prefetch" href="/to-be-bast/assets/js/34.5ee668ce.js"><link rel="prefetch" href="/to-be-bast/assets/js/35.8b547770.js"><link rel="prefetch" href="/to-be-bast/assets/js/36.2acc3458.js"><link rel="prefetch" href="/to-be-bast/assets/js/37.077c6e56.js"><link rel="prefetch" href="/to-be-bast/assets/js/38.11563a61.js"><link rel="prefetch" href="/to-be-bast/assets/js/39.07d7a301.js"><link rel="prefetch" href="/to-be-bast/assets/js/4.d12742be.js"><link rel="prefetch" href="/to-be-bast/assets/js/40.30a9124a.js"><link rel="prefetch" href="/to-be-bast/assets/js/41.a2876b17.js"><link rel="prefetch" href="/to-be-bast/assets/js/42.67ec8031.js"><link rel="prefetch" href="/to-be-bast/assets/js/43.000c7c57.js"><link rel="prefetch" href="/to-be-bast/assets/js/44.ebcefafd.js"><link rel="prefetch" href="/to-be-bast/assets/js/45.c0542bf1.js"><link rel="prefetch" href="/to-be-bast/assets/js/46.885b14aa.js"><link rel="prefetch" href="/to-be-bast/assets/js/47.bad3ee03.js"><link rel="prefetch" href="/to-be-bast/assets/js/48.5cae63f1.js"><link rel="prefetch" href="/to-be-bast/assets/js/49.f7f0e9bd.js"><link rel="prefetch" href="/to-be-bast/assets/js/5.216cae74.js"><link rel="prefetch" href="/to-be-bast/assets/js/50.0f8dfcf4.js"><link rel="prefetch" href="/to-be-bast/assets/js/51.2c964dc0.js"><link rel="prefetch" href="/to-be-bast/assets/js/52.e12923d4.js"><link rel="prefetch" href="/to-be-bast/assets/js/53.8e58b6aa.js"><link rel="prefetch" href="/to-be-bast/assets/js/54.9c0c208f.js"><link rel="prefetch" href="/to-be-bast/assets/js/55.0d700812.js"><link rel="prefetch" href="/to-be-bast/assets/js/56.3c84f5d6.js"><link rel="prefetch" href="/to-be-bast/assets/js/57.3813517d.js"><link rel="prefetch" href="/to-be-bast/assets/js/58.d2454e98.js"><link rel="prefetch" href="/to-be-bast/assets/js/59.00a0b442.js"><link rel="prefetch" href="/to-be-bast/assets/js/6.2d0a63f8.js"><link rel="prefetch" href="/to-be-bast/assets/js/60.dc71c357.js"><link rel="prefetch" href="/to-be-bast/assets/js/61.243b7158.js"><link rel="prefetch" href="/to-be-bast/assets/js/62.ed7cb8b4.js"><link rel="prefetch" href="/to-be-bast/assets/js/64.84f845fd.js"><link rel="prefetch" href="/to-be-bast/assets/js/65.0cea4cc9.js"><link rel="prefetch" href="/to-be-bast/assets/js/66.2d776da3.js"><link rel="prefetch" href="/to-be-bast/assets/js/67.eeaa7ab3.js"><link rel="prefetch" href="/to-be-bast/assets/js/68.bb2e319b.js"><link rel="prefetch" href="/to-be-bast/assets/js/69.5363dc47.js"><link rel="prefetch" href="/to-be-bast/assets/js/7.2f0859e3.js"><link rel="prefetch" href="/to-be-bast/assets/js/70.f5829a44.js"><link rel="prefetch" href="/to-be-bast/assets/js/71.3226e5b5.js"><link rel="prefetch" href="/to-be-bast/assets/js/72.4bc7c7a3.js"><link rel="prefetch" href="/to-be-bast/assets/js/73.4f01d8fc.js"><link rel="prefetch" href="/to-be-bast/assets/js/74.455ffd32.js"><link rel="prefetch" href="/to-be-bast/assets/js/75.adbb6e85.js"><link rel="prefetch" href="/to-be-bast/assets/js/76.8aeea110.js"><link rel="prefetch" href="/to-be-bast/assets/js/77.f4e5bcff.js"><link rel="prefetch" href="/to-be-bast/assets/js/78.0eb64265.js"><link rel="prefetch" href="/to-be-bast/assets/js/79.2155f6c9.js"><link rel="prefetch" href="/to-be-bast/assets/js/8.28816398.js"><link rel="prefetch" href="/to-be-bast/assets/js/9.c31128b6.js">
    <link rel="stylesheet" href="/to-be-bast/assets/css/0.styles.be698e14.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/to-be-bast/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/to-be-bast/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="你皮05的 Java 博客" class="dropdown-title"><span class="title">你皮05的 Java 博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="你皮05的 Java 博客" class="mobile-dropdown-title"><span class="title">你皮05的 Java 博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/haha-zwx-ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/to-be-bast/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="你皮05的 Java 博客" class="dropdown-title"><span class="title">你皮05的 Java 博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="你皮05的 Java 博客" class="mobile-dropdown-title"><span class="title">你皮05的 Java 博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/haha-zwx-ooo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/to-be-bast/" aria-current="page" class="sidebar-link">职业技能</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/basic/Java数据类型" class="sidebar-heading clickable"><span>Java基础知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/core/多线程一" class="sidebar-heading clickable"><span>Java核心技术</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/web/servlet" class="sidebar-heading clickable"><span>JavaWeb</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/db/db" class="sidebar-heading clickable"><span>数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/designpattern/designpattern" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/frame/frame" class="sidebar-heading clickable open"><span>框架和工具</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/to-be-bast/frame/spring.html" class="sidebar-link">spring</a></li><li><a href="/to-be-bast/frame/proxy.html" class="sidebar-link">Java代理</a></li><li><a href="/to-be-bast/frame/springboot.html" class="sidebar-link">springboot</a></li><li><a href="/to-be-bast/frame/mybatis.html" class="sidebar-link">mybatis</a></li><li><a href="/to-be-bast/frame/mybatis-plus.html" class="sidebar-link">mybatis-plus</a></li><li><a href="/to-be-bast/frame/springcloud.html" class="sidebar-link">springCloud</a></li><li><a href="/to-be-bast/frame/springcloud源码eureka.html" class="active sidebar-link">springCloud源码分析eureka</a></li><li><a href="/to-be-bast/frame/springcloud源码ribbon.html" class="sidebar-link">springcloud源码ribbon</a></li><li><a href="/to-be-bast/frame/springcloud源码feign.html" class="sidebar-link">springcloud源码feign</a></li><li><a href="/to-be-bast/frame/springcloud源码hystrix.html" class="sidebar-link">springcloud源码hystrix</a></li><li><a href="/to-be-bast/frame/springcloudalibaba.html" class="sidebar-link">Spring Cloud Alibaba</a></li><li><a href="/to-be-bast/frame/springcloudalibaba源码nacos.html" class="sidebar-link">springcloudalibaba源码nacos</a></li><li><a href="/to-be-bast/frame/springcloudalibaba源码sentinel.html" class="sidebar-link">springcloudalibaba源码sentinel</a></li><li><a href="/to-be-bast/frame/dubbo.html" class="sidebar-link">dubbo</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/cache/cache" class="sidebar-heading clickable"><span>缓存</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/mq/mq" class="sidebar-heading clickable"><span>消息队列</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/lock/lock" class="sidebar-heading clickable"><span>分布式锁</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/to-be-bast/tr/tr" class="sidebar-heading clickable"><span>分布式事务</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springcloud源码分析eureka"><a href="#springcloud源码分析eureka" class="header-anchor">#</a> springCloud源码分析eureka</h1> <div class="language-xml extra-class"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>因为时spring-cloud-starter 所以上来看spi扩展</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\
  org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration</span>
</code></pre></div><p>看下EurekaServerAutoConfiguration</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerInitializerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerMarkerConfiguration<span class="token punctuation">.</span>Marker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">EurekaDashboardProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">InstanceRegistryProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:/eureka/server.properties&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerAutoConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebMvcConfigurerAdapter</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token comment">//EurekaServerInitializerConfiguration</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerInitializerConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ServletContextAware</span><span class="token punctuation">,</span> <span class="token class-name">SmartLifecycle</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerInitializerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">EurekaServerConfig</span> eurekaServerConfig<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">EurekaServerBootstrap</span> eurekaServerBootstrap<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> running<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">int</span> order <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setServletContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext <span class="token operator">=</span> servletContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//TODO: is this class even needed now?</span>
                    eurekaServerBootstrap<span class="token punctuation">.</span><span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerInitializerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Started Eureka Server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EurekaRegistryAvailableEvent</span><span class="token punctuation">(</span><span class="token function">getEurekaServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">EurekaServerInitializerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EurekaServerStartedEvent</span><span class="token punctuation">(</span><span class="token function">getEurekaServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Help!</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Could not initialize Eureka servlet context&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token class-name">EurekaServerConfig</span> <span class="token function">getEurekaServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eurekaServerConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        eurekaServerBootstrap<span class="token punctuation">.</span><span class="token function">contextDestroyed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAutoStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">//EurekaServerMarkerConfiguration</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerMarkerConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Marker</span> <span class="token function">eurekaServerMarkerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Marker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Marker</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SmartLifecycle 是一个接口。当Spring容器加载所有bean并完成初始化之后，会接着回调实现该接口的类中对应的方法（start()方法）。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerInitializerConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ServletContextAware</span><span class="token punctuation">,</span> <span class="token class-name">SmartLifecycle</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//TODO: is this class even needed now?</span>
                    <span class="token comment">// TODO 这里开始启动eureka服务</span>
                    eurekaServerBootstrap<span class="token punctuation">.</span><span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerInitializerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Started Eureka Server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 发布eureka 注册事件</span>
                    <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EurekaRegistryAvailableEvent</span><span class="token punctuation">(</span><span class="token function">getEurekaServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">EurekaServerInitializerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">// 发布eureka启动事件</span>
                    <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EurekaServerStartedEvent</span><span class="token punctuation">(</span><span class="token function">getEurekaServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Help!</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Could not initialize Eureka servlet context&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>eurekaServerBootstrap.contextInitialized(EurekaServerInitializerConfiguration.this.servletContext);</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerBootstrap</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">initEurekaEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initEurekaServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            context<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot bootstrap eureka server :&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot bootstrap eureka server :&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initEurekaServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// For backward compatibility</span>
        <span class="token class-name">JsonXStream</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerConverter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">V1AwareInstanceInfoConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XStream</span><span class="token punctuation">.</span><span class="token constant">PRIORITY_VERY_HIGH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XmlXStream</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerConverter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">V1AwareInstanceInfoConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XStream</span><span class="token punctuation">.</span><span class="token constant">PRIORITY_VERY_HIGH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAws</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationInfoManager<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>awsBinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AwsBinderDelegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eurekaServerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eurekaClientConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">,</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>applicationInfoManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>awsBinder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token class-name">EurekaServerContextHolder</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Initialized server context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Copy registry from neighboring eureka node</span>
        <span class="token comment">// 从相邻的eureka复制服务列表</span>
        <span class="token keyword">int</span> registryCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">syncUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">openForTraffic</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationInfoManager<span class="token punctuation">,</span> registryCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Register all monitoring statistics.</span>
        <span class="token class-name">EurekaMonitors</span><span class="token punctuation">.</span><span class="token function">registerAllStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PeerAwareInstanceRegistryImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractInstanceRegistry</span> <span class="token keyword">implements</span> <span class="token class-name">PeerAwareInstanceRegistry</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// TODO 从其他eureka节点同步服务列表</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">syncUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Copy entire entry from neighboring DS node</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> serverConfig<span class="token punctuation">.</span><span class="token function">getRegistrySyncRetries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">.</span><span class="token function">getRegistrySyncRetryWaitMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Interrupted during registry transfer..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Applications</span> apps <span class="token operator">=</span> eurekaClient<span class="token punctuation">.</span><span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Application</span> app <span class="token operator">:</span> apps<span class="token punctuation">.</span><span class="token function">getRegisteredApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InstanceInfo</span> instance <span class="token operator">:</span> app<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRegisterable</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">register</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDurationInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            count<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;During DS init copy&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>
        <span class="token class-name">Heartbeat</span><span class="token punctuation">,</span>
        <span class="token class-name">Register</span><span class="token punctuation">,</span>
        <span class="token class-name">Cancel</span><span class="token punctuation">,</span>
        <span class="token class-name">StatusUpdate</span><span class="token punctuation">,</span>
        <span class="token class-name">DeleteStatusOverride</span><span class="token punctuation">;</span>
        
        <span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>servo<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span>Timer</span> timer <span class="token operator">=</span> <span class="token class-name">Monitors</span><span class="token punctuation">.</span><span class="token function">newTimer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>servo<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span></span>Timer</span> <span class="token function">getTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 注册逻辑
     * @param info
     * @param isReplication
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InstanceInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> leaseDuration <span class="token operator">=</span> <span class="token class-name">Lease</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_DURATION_IN_SECS</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDurationInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            leaseDuration <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDurationInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> leaseDuration<span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 同步给其他节点</span>
        <span class="token function">replicateToPeers</span><span class="token punctuation">(</span><span class="token class-name">Action<span class="token punctuation">.</span>Register</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 同步到其他节点逻辑
     * @param action
     * @param appName
     * @param id
     * @param info
     * @param newStatus
     * @param node
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replicateInstanceActionsToPeers</span><span class="token punctuation">(</span><span class="token class-name">Action</span> action<span class="token punctuation">,</span> <span class="token class-name">String</span> appName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">InstanceInfo</span> info<span class="token punctuation">,</span>
            <span class="token class-name">InstanceStatus</span> newStatus<span class="token punctuation">,</span> <span class="token class-name">PeerEurekaNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">InstanceInfo</span> infoFromRegistry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">CurrentRequestVersion</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token constant">V2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token class-name">Cancel</span><span class="token operator">:</span>
                    node<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Heartbeat</span><span class="token operator">:</span>
                    <span class="token class-name">InstanceStatus</span> overriddenStatus <span class="token operator">=</span> overriddenInstanceStatusMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    infoFromRegistry <span class="token operator">=</span> <span class="token function">getInstanceByAppAndId</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span><span class="token function">heartbeat</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">,</span> infoFromRegistry<span class="token punctuation">,</span> overriddenStatus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Register</span><span class="token operator">:</span>
                    node<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">StatusUpdate</span><span class="token operator">:</span>
                    infoFromRegistry <span class="token operator">=</span> <span class="token function">getInstanceByAppAndId</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span><span class="token function">statusUpdate</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">,</span> newStatus<span class="token punctuation">,</span> infoFromRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">DeleteStatusOverride</span><span class="token operator">:</span>
                    infoFromRegistry <span class="token operator">=</span> <span class="token function">getInstanceByAppAndId</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span><span class="token function">deleteStatusOverride</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> id<span class="token punctuation">,</span> infoFromRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot replicate information to {} for action {}&quot;</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">getServiceUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 同步其他eureka节点的注册信息同步逻辑
     * @param info
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InstanceInfo</span> info<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> expiryTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">getLeaseRenewalOf</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchingDispatcher<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token function">taskId</span><span class="token punctuation">(</span><span class="token string">&quot;register&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">InstanceReplicationTask</span><span class="token punctuation">(</span>targetHost<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">.</span>Register</span><span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> replicationClient<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> expiryTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">//batchingDispatcher.process 是eureka封装的一个线程池</span>
<span class="token comment">//由此可见eureka的数据同步给其他节点是异步操作，不能保证数据一致性</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskDispatchers</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">final</span> <span class="token class-name">AcceptorExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> acceptorExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AcceptorExecutor</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> maxBufferSize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> maxBatchingDelay<span class="token punctuation">,</span>
            congestionRetryDelayMs<span class="token punctuation">,</span> networkFailureRetryMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">final</span> <span class="token class-name">TaskExecutors</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> taskExecutor <span class="token operator">=</span> <span class="token class-name">TaskExecutors</span><span class="token punctuation">.</span><span class="token function">singleItemExecutors</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> workerCount<span class="token punctuation">,</span> taskProcessor<span class="token punctuation">,</span>
            acceptorExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面分析了,eureka启动的时候会同步拉取其他eureka节点的服务列表,也会把客户端事件同步给其他节点,都是异步完成</p> <p>那么eureka-server接受客户端请求在那,在ApplicationResource</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;application/xml&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationResource</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ApplicationResource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> appName<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EurekaServerConfig</span> serverConfig<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PeerAwareInstanceRegistry</span> registry<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResponseCache</span> responseCache<span class="token punctuation">;</span>
    
    <span class="token class-name">ApplicationResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> appName<span class="token punctuation">,</span> <span class="token class-name">EurekaServerConfig</span> serverConfig<span class="token punctuation">,</span> <span class="token class-name">PeerAwareInstanceRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>appName <span class="token operator">=</span> appName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverConfig <span class="token operator">=</span> serverConfig<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>responseCache <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getResponseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> appName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Gets information about a particular {@link com.netflix.discovery.shared.Application}.
     *
     * @param version
     *            the version of the request.
     * @param acceptHeader
     *            the accept header of the request to indicate whether to serve
     *            JSON or XML data.
     * @return the response containing information about a particular
     *         application.
     */</span>
    <span class="token annotation punctuation">@GET</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">&quot;version&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> version<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@HeaderParam</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> acceptHeader<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@HeaderParam</span><span class="token punctuation">(</span><span class="token class-name">EurekaAccept</span><span class="token punctuation">.</span><span class="token constant">HTTP_X_EUREKA_ACCEPT</span><span class="token punctuation">)</span> <span class="token class-name">String</span> eurekaAccept<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">shouldAllowAccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token class-name">EurekaMonitors</span><span class="token punctuation">.</span><span class="token constant">GET_APPLICATION</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CurrentRequestVersion</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token function">toEnum</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyType</span> keyType <span class="token operator">=</span> <span class="token class-name">Key<span class="token punctuation">.</span>KeyType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptHeader <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>acceptHeader<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            keyType <span class="token operator">=</span> <span class="token class-name">Key<span class="token punctuation">.</span>KeyType</span><span class="token punctuation">.</span><span class="token constant">XML</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token class-name">Key</span> cacheKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Key</span><span class="token punctuation">(</span><span class="token class-name">Key<span class="token punctuation">.</span>EntityType<span class="token punctuation">.</span>Application</span><span class="token punctuation">,</span> appName<span class="token punctuation">,</span> keyType<span class="token punctuation">,</span> <span class="token class-name">CurrentRequestVersion</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">EurekaAccept</span><span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>eurekaAccept<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> payLoad <span class="token operator">=</span> responseCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payLoad <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Found: {}&quot;</span><span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>payLoad<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Not Found: {}&quot;</span><span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Gets information about a particular instance of an application.
     *
     * @param id
     *            the unique identifier of the instance.
     * @return information about a particular instance.
     */</span>
    <span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">&quot;{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">InstanceResource</span> <span class="token function">getInstanceInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InstanceResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> serverConfig<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Registers information about a particular instance for an
     * {@link com.netflix.discovery.shared.Application}.
     *
     * @param info
     *            {@link InstanceInfo} information of the instance.
     * @param isReplication
     *            a header parameter containing information whether this is
     *            replicated from other nodes.
     */</span>
    <span class="token annotation punctuation">@POST</span>
    <span class="token annotation punctuation">@Consumes</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/xml&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">addInstance</span><span class="token punctuation">(</span><span class="token class-name">InstanceInfo</span> info<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@HeaderParam</span><span class="token punctuation">(</span><span class="token class-name">PeerEurekaNode</span><span class="token punctuation">.</span><span class="token constant">HEADER_REPLICATION</span><span class="token punctuation">)</span> <span class="token class-name">String</span> isReplication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Registering instance {} (replication={})&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// validate that the instanceinfo contains all the necessary required fields</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlank</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Missing instanceId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlank</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Missing hostname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlank</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getIPAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Missing ip address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlank</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Missing appName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>appName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Mismatched appName, expecting &quot;</span> <span class="token operator">+</span> appName <span class="token operator">+</span> <span class="token string">&quot; but was &quot;</span> <span class="token operator">+</span> info<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getDataCenterInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Missing dataCenterInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getDataCenterInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;Missing dataCenterInfo Name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span>
        <span class="token class-name">DataCenterInfo</span> dataCenterInfo <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token function">getDataCenterInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataCenterInfo <span class="token keyword">instanceof</span> <span class="token class-name">UniqueIdentifier</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> dataCenterInfoId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UniqueIdentifier</span><span class="token punctuation">)</span> dataCenterInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dataCenterInfoId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> experimental <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>
                        serverConfig<span class="token punctuation">.</span><span class="token function">getExperimental</span><span class="token punctuation">(</span><span class="token string">&quot;registration.validation.dataCenterInfoId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>experimental<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> entity <span class="token operator">=</span> <span class="token string">&quot;DataCenterInfo of type &quot;</span> <span class="token operator">+</span> dataCenterInfo<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must contain a valid id&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataCenterInfo <span class="token keyword">instanceof</span> <span class="token class-name">AmazonInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AmazonInfo</span> amazonInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AmazonInfo</span><span class="token punctuation">)</span> dataCenterInfo<span class="token punctuation">;</span>
                    <span class="token class-name">String</span> effectiveId <span class="token operator">=</span> amazonInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AmazonInfo<span class="token punctuation">.</span>MetaDataKey</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectiveId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        amazonInfo<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">AmazonInfo<span class="token punctuation">.</span>MetaDataKey</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Registering DataCenterInfo of type {} without an appropriate id&quot;</span><span class="token punctuation">,</span>
                            dataCenterInfo<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isReplication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 204 to be backwards compatible</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Returns the application name of a particular application.
     *
     * @return the application name of a particular application.
     */</span>
    <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> appName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> str <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里核心分析addInstance方法</p> <div class="language- extra-class"><pre class="language-text"><code>registry.register(info,&quot;true&quot;.equals(isReplication));
        
super.register(info,leaseDuration,isReplication);

// 注册服务保存结构，是双层map，
外层map key 是servername，内存map key是instenceId,对应的是一个服务多个实例
private final ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry
            = new ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();
            
    public void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {
        try {
            read.lock();
            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());
            REGISTER.increment(isReplication);
            if (gMap == null) {
                final ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = new ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();
                gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap);
                if (gMap == null) {
                    gMap = gNewMap;
                }
            }
            Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());
            // Retain the last dirty timestamp without overwriting it, if there is already a lease
            if (existingLease != null &amp;&amp; (existingLease.getHolder() != null)) {
                Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp();
                Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp();
                logger.debug(&quot;Existing lease found (existing={}, provided={}&quot;, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);

                // this is a &gt; instead of a &gt;= because if the timestamps are equal, we still take the remote transmitted
                // InstanceInfo instead of the server local copy.
                if (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) {
                    logger.warn(&quot;There is an existing lease and the existing lease's dirty timestamp {} is greater&quot; +
                            &quot; than the one that is being registered {}&quot;, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);
                    logger.warn(&quot;Using the existing instanceInfo instead of the new instanceInfo as the registrant&quot;);
                    registrant = existingLease.getHolder();
                }
            } else {
                // The lease does not exist and hence it is a new registration
                synchronized (lock) {
                    if (this.expectedNumberOfClientsSendingRenews &gt; 0) {
                        // Since the client wants to register it, increase the number of clients sending renews
                        this.expectedNumberOfClientsSendingRenews = this.expectedNumberOfClientsSendingRenews + 1;
                        updateRenewsPerMinThreshold();
                    }
                }
                logger.debug(&quot;No previous lease information found; it is new registration&quot;);
            }
            Lease&lt;InstanceInfo&gt; lease = new Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);
            if (existingLease != null) {
                lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());
            }
            gMap.put(registrant.getId(), lease);
            synchronized (recentRegisteredQueue) {
                recentRegisteredQueue.add(new Pair&lt;Long, String&gt;(
                        System.currentTimeMillis(),
                        registrant.getAppName() + &quot;(&quot; + registrant.getId() + &quot;)&quot;));
            }
            // This is where the initial state transfer of overridden status happens
            if (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) {
                logger.debug(&quot;Found overridden status {} for instance {}. Checking to see if needs to be add to the &quot;
                                + &quot;overrides&quot;, registrant.getOverriddenStatus(), registrant.getId());
                if (!overriddenInstanceStatusMap.containsKey(registrant.getId())) {
                    logger.info(&quot;Not found overridden id {} and hence adding it&quot;, registrant.getId());
                    overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());
                }
            }
            InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());
            if (overriddenStatusFromMap != null) {
                logger.info(&quot;Storing overridden status {} from map&quot;, overriddenStatusFromMap);
                registrant.setOverriddenStatus(overriddenStatusFromMap);
            }

            // Set the status based on the overridden status rules
            InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);
            registrant.setStatusWithoutDirty(overriddenInstanceStatus);

            // If the lease is registered with UP status, set lease service up timestamp
            if (InstanceStatus.UP.equals(registrant.getStatus())) {
                lease.serviceUp();
            }
            registrant.setActionType(ActionType.ADDED);
            recentlyChangedQueue.add(new RecentlyChangedItem(lease));
            registrant.setLastUpdatedTimestamp();
            invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());
            logger.info(&quot;Registered instance {}/{} with status {} (replication={})&quot;,
                    registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);
        } finally {
            read.unlock();
        }
    }
    
    invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());
    这里使用了缓存机制
    // 读缓存
    private final ConcurrentMap&lt;Key, Value&gt; readOnlyCacheMap = new ConcurrentHashMap&lt;Key, Value&gt;();
    // 读写缓存
    private final LoadingCache&lt;Key, Value&gt; readWriteCacheMap;
    // 缓存同步机制
    if (shouldUseReadOnlyResponseCache) {
            timer.schedule(getCacheUpdateTask(),
                    new Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)
                            + responseCacheUpdateIntervalMs),
                    responseCacheUpdateIntervalMs);
        }
    
     private TimerTask getCacheUpdateTask() {
        return new TimerTask() {
            @Override
            public void run() {
                logger.debug(&quot;Updating the client cache from response cache&quot;);
                for (Key key : readOnlyCacheMap.keySet()) {
                    if (logger.isDebugEnabled()) {
                        logger.debug(&quot;Updating the client cache from response cache for key : {} {} {} {}&quot;,
                                key.getEntityType(), key.getName(), key.getVersion(), key.getType());
                    }
                    try {
                        CurrentRequestVersion.set(key.getVersion());
                        Value cacheValue = readWriteCacheMap.get(key);
                        Value currentCacheValue = readOnlyCacheMap.get(key);
                        if (cacheValue != currentCacheValue) {
                            readOnlyCacheMap.put(key, cacheValue);
                        }
                    } catch (Throwable th) {
                        logger.error(&quot;Error while updating the client cache from response cache for key {}&quot;, key.toStringCompact(), th);
                    }
                }
            }
        };
    }
    
    // 读缓存逻辑，先从readOnlyCacheMap读，如果为null在从readWriteCacheMap读
    Value getValue(final Key key, boolean useReadOnlyCache) {
        Value payload = null;
        try {
            if (useReadOnlyCache) {
                final Value currentPayload = readOnlyCacheMap.get(key);
                if (currentPayload != null) {
                    payload = currentPayload;
                } else {
                    payload = readWriteCacheMap.get(key);
                    readOnlyCacheMap.put(key, payload);
                }
            } else {
                payload = readWriteCacheMap.get(key);
            }
        } catch (Throwable t) {
            logger.error(&quot;Cannot get value for key : {}&quot;, key, t);
        }
        return payload;
    }   
</code></pre></div><p>服务端的源码基本就是这样,下面看客户端的源码</p> <div class="language-xml extra-class"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>spi</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\
org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\
org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\
org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\
org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration,\
org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span>
<span class="token key attr-name">org.springframework.cloud.bootstrap.BootstrapConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\
org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClientAutoConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnMissingRefreshScope</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClientConfiguration</span> <span class="token punctuation">{</span>
        
        <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">EurekaClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span><span class="token constant">CURRENT</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">EurekaClient</span> <span class="token function">eurekaClient</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInfoManager</span> manager<span class="token punctuation">,</span> <span class="token class-name">EurekaClientConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CloudEurekaClient</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>optionalArgs<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">EurekaClientConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;eureka.client.enabled&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaDiscoveryClientConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Marker</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Marker</span> <span class="token function">eurekaDiscoverClientMarker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Marker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RefreshScopeRefreshedEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClientConfigurationRefresher</span>
            <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefreshScopeRefreshedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        
        <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">EurekaClient</span> eurekaClient<span class="token punctuation">;</span>
        
        <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">EurekaAutoServiceRegistration</span> autoRegistration<span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">RefreshScopeRefreshedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//This will force the creation of the EurkaClient bean if not already created</span>
            <span class="token comment">//to make sure the client will be reregistered after a refresh event</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eurekaClient <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eurekaClient<span class="token punctuation">.</span><span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>autoRegistration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// register in case meta data changed</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>autoRegistration<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>autoRegistration<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;eureka.client.healthcheck.enabled&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EurekaHealthCheckHandlerConfiguration</span> <span class="token punctuation">{</span>
        
        <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">HealthAggregator</span> healthAggregator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderedHealthAggregator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token annotation punctuation">@Bean</span>
        <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">HealthCheckHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">EurekaHealthCheckHandler</span> <span class="token function">eurekaHealthCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EurekaHealthCheckHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>healthAggregator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
    
    <span class="token comment">//重点是这个</span>
    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">EurekaClient</span> eurekaClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ImplementedBy</span><span class="token punctuation">(</span><span class="token class-name">DiscoveryClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EurekaClient</span> <span class="token keyword">extends</span> <span class="token class-name">LookupService</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token comment">//DiscoveryClient</span>
<span class="token comment">//构造方法中初始化了几个定时任务，heartbeatExecutor  cacheRefreshExecutor</span>
<span class="token annotation punctuation">@Singleton</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscoveryClient</span> <span class="token keyword">implements</span> <span class="token class-name">EurekaClient</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> scheduler<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> heartbeatExecutor<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> cacheRefreshExecutor<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Inject</span>
    <span class="token class-name">DiscoveryClient</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInfoManager</span> applicationInfoManager<span class="token punctuation">,</span> <span class="token class-name">EurekaClientConfig</span> config<span class="token punctuation">,</span>
            <span class="token class-name">AbstractDiscoveryClientOptionalArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">Provider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BackupRegistry</span><span class="token punctuation">&gt;</span></span> backupRegistryProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>healthCheckHandlerProvider <span class="token operator">=</span> args<span class="token punctuation">.</span>healthCheckHandlerProvider<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>healthCheckCallbackProvider <span class="token operator">=</span> args<span class="token punctuation">.</span>healthCheckCallbackProvider<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>eventListeners<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">getEventListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>preRegistrationHandler <span class="token operator">=</span> args<span class="token punctuation">.</span>preRegistrationHandler<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>healthCheckCallbackProvider <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>healthCheckHandlerProvider <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>preRegistrationHandler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationInfoManager <span class="token operator">=</span> applicationInfoManager<span class="token punctuation">;</span>
        <span class="token class-name">InstanceInfo</span> myInfo <span class="token operator">=</span> applicationInfoManager<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        clientConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>
        staticClientConfig <span class="token operator">=</span> clientConfig<span class="token punctuation">;</span>
        transportConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTransportConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instanceInfo <span class="token operator">=</span> myInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>myInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            appPathIdentifier <span class="token operator">=</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Setting instanceInfo to a passed in null value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>backupRegistryProvider <span class="token operator">=</span> backupRegistryProvider<span class="token punctuation">;</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>urlRandomizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndpointUtils<span class="token punctuation">.</span>InstanceInfoBasedUrlRandomizer</span><span class="token punctuation">(</span>instanceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localRegionApps<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Applications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        fetchRegistryGeneration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        remoteRegionsToFetch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">fetchRegistryForRemoteRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remoteRegionsRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                remoteRegionsToFetch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> remoteRegionsToFetch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registryStalenessMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThresholdLevelsMetric</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">METRIC_REGISTRY_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;lastUpdateSec_&quot;</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">15L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token number">120L</span><span class="token punctuation">,</span> <span class="token number">240L</span><span class="token punctuation">,</span> <span class="token number">480L</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registryStalenessMonitor <span class="token operator">=</span> <span class="token class-name">ThresholdLevelsMetric</span><span class="token punctuation">.</span><span class="token constant">NO_OP_METRIC</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">shouldRegisterWithEureka</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatStalenessMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThresholdLevelsMetric</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                    <span class="token constant">METRIC_REGISTRATION_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;lastHeartbeatSec_&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">15L</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token number">120L</span><span class="token punctuation">,</span> <span class="token number">240L</span><span class="token punctuation">,</span> <span class="token number">480L</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatStalenessMonitor <span class="token operator">=</span> <span class="token class-name">ThresholdLevelsMetric</span><span class="token punctuation">.</span><span class="token constant">NO_OP_METRIC</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Initializing Eureka in region {}&quot;</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">shouldRegisterWithEureka</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Client configured to neither register nor query for data.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scheduler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            heartbeatExecutor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            cacheRefreshExecutor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            eurekaTransport <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            instanceRegionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstanceRegionChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PropertyBasedAzToRegionMapper</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    clientConfig<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span>
            <span class="token comment">// to work with DI'd DiscoveryClient</span>
            <span class="token class-name">DiscoveryManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDiscoveryClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DiscoveryManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEurekaClientConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            initTimestampMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Discovery Client initialized at timestamp {} with initial instances count: {}&quot;</span><span class="token punctuation">,</span>
                    initTimestampMs<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// no need to setup up an network tasks and we are done</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span>
            scheduler <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DiscoveryClient-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            heartbeatExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatExecutorThreadPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DiscoveryClient-HeartbeatExecutor-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// use direct handoff</span>
            
            cacheRefreshExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getCacheRefreshExecutorThreadPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DiscoveryClient-CacheRefreshExecutor-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// use direct handoff</span>
            
            eurekaTransport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EurekaTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scheduleServerEndpointTask</span><span class="token punctuation">(</span>eurekaTransport<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token class-name">AzToRegionMapper</span> azToRegionMapper<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldUseDnsForFetchingServiceUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                azToRegionMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DNSBasedAzToRegionMapper</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                azToRegionMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PropertyBasedAzToRegionMapper</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> remoteRegionsToFetch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                azToRegionMapper<span class="token punctuation">.</span><span class="token function">setRegionsToFetch</span><span class="token punctuation">(</span>remoteRegionsToFetch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            instanceRegionChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstanceRegionChecker</span><span class="token punctuation">(</span>azToRegionMapper<span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to initialize DiscoveryClient!&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">fetchRegistry</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fetchRegistryFromBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// call and execute the pre registration handler before all background tasks (inc registration) is started</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>preRegistrationHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>preRegistrationHandler<span class="token punctuation">.</span><span class="token function">beforeRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldRegisterWithEureka</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> clientConfig<span class="token punctuation">.</span><span class="token function">shouldEnforceRegistrationAtInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//TODO 这里很关键，是注册逻辑，会判断配置文件是否注册到eureka，</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Registration error at startup. Invalid server response.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> th<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Registration error at startup: {}&quot;</span><span class="token punctuation">,</span> th<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>th<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// finally, init the schedule tasks (e.g. cluster resolvers, heartbeat, instanceInfo replicator, fetch</span>
        <span class="token comment">//TODO 初始化定时任务</span>
        <span class="token function">initScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Monitors</span><span class="token punctuation">.</span><span class="token function">registerObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot register timers&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span>
        <span class="token comment">// to work with DI'd DiscoveryClient</span>
        <span class="token class-name">DiscoveryManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDiscoveryClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DiscoveryManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEurekaClientConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        initTimestampMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Discovery Client initialized at timestamp {} with initial instances count: {}&quot;</span><span class="token punctuation">,</span> initTimestampMs<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面代码中我加了2个TODO 很关键,一个是注册,一个初始化定时任务</p> <ul><li>register</li> <li>initScheduledTasks</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscoveryClient</span> <span class="token keyword">implements</span> <span class="token class-name">EurekaClient</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Applications</span><span class="token punctuation">&gt;</span></span> localRegionApps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Applications</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">// 注册逻辑，就是一个http请求</span>
    <span class="token keyword">boolean</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;{}: registering service...&quot;</span><span class="token punctuation">,</span> appPathIdentifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> httpResponse<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            httpResponse <span class="token operator">=</span> eurekaTransport<span class="token punctuation">.</span>registrationClient<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>instanceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;{} - registration failed {}&quot;</span><span class="token punctuation">,</span> appPathIdentifier<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;{} - registration status: {}&quot;</span><span class="token punctuation">,</span> appPathIdentifier<span class="token punctuation">,</span> httpResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> httpResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">NO_CONTENT</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 注册逻辑，url是 apps/serverName  POST请求</span>
    <span class="token keyword">public</span> <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">InstanceInfo</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> urlPath <span class="token operator">=</span> <span class="token string">&quot;apps/&quot;</span> <span class="token operator">+</span> info<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClientResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Builder</span> resourceBuilder <span class="token operator">=</span> jerseyClient<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>serviceUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addExtraHeaders</span><span class="token punctuation">(</span>resourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response <span class="token operator">=</span> resourceBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_TYPE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">ClientResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">anEurekaHttpResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token function">headersOf</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Jersey HTTP POST {}/{} with instance {}; statusCode={}&quot;</span><span class="token punctuation">,</span> serviceUrl<span class="token punctuation">,</span> urlPath<span class="token punctuation">,</span>
                        info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;N/A&quot;</span> <span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 定时任务</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//配置文件是否拉取服务列表</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// registry cache refresh timer</span>
            <span class="token keyword">int</span> registryFetchIntervalSeconds <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryFetchIntervalSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> expBackOffBound <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">getCacheRefreshExecutorExponentialBackOffBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimedSupervisorTask</span><span class="token punctuation">(</span><span class="token string">&quot;cacheRefresh&quot;</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> cacheRefreshExecutor<span class="token punctuation">,</span>
                            registryFetchIntervalSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> expBackOffBound<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CacheRefreshThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    registryFetchIntervalSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldRegisterWithEureka</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> renewalIntervalInSecs <span class="token operator">=</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRenewalIntervalInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> expBackOffBound <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatExecutorExponentialBackOffBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting heartbeat executor: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;renew interval is: {}&quot;</span><span class="token punctuation">,</span> renewalIntervalInSecs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// Heartbeat timer</span>
            scheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimedSupervisorTask</span><span class="token punctuation">(</span><span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> heartbeatExecutor<span class="token punctuation">,</span> renewalIntervalInSecs<span class="token punctuation">,</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> expBackOffBound<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HeartbeatThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renewalIntervalInSecs<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// InstanceInfo replicator</span>
            instanceInfoReplicator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstanceInfoReplicator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> instanceInfo<span class="token punctuation">,</span>
                    clientConfig<span class="token punctuation">.</span><span class="token function">getInstanceInfoReplicationIntervalSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// burstSize</span>
            
            statusChangeListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationInfoManager<span class="token punctuation">.</span>StatusChangeListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;statusChangeListener&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">StatusChangeEvent</span> statusChangeEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InstanceStatus</span><span class="token punctuation">.</span><span class="token constant">DOWN</span> <span class="token operator">==</span> statusChangeEvent<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">||</span> <span class="token class-name">InstanceStatus</span><span class="token punctuation">.</span><span class="token constant">DOWN</span> <span class="token operator">==</span> statusChangeEvent<span class="token punctuation">.</span><span class="token function">getPreviousStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// log at warn level if DOWN was involved</span>
                        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Saw local status change event {}&quot;</span><span class="token punctuation">,</span> statusChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Saw local status change event {}&quot;</span><span class="token punctuation">,</span> statusChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    instanceInfoReplicator<span class="token punctuation">.</span><span class="token function">onDemandUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldOnDemandUpdateStatusChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                applicationInfoManager<span class="token punctuation">.</span><span class="token function">registerStatusChangeListener</span><span class="token punctuation">(</span>statusChangeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            instanceInfoReplicator<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">getInitialInstanceInfoReplicationIntervalSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Not registering with Eureka server per configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 客户端定时任务拉取服务端服务列表逻辑</span>
    <span class="token keyword">void</span> <span class="token function">refreshRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> isFetchingRemoteRegionRegistries <span class="token operator">=</span> <span class="token function">isFetchingRemoteRegionRegistries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">boolean</span> remoteRegionsModified <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// This makes sure that a dynamic change to remote regions to fetch is honored.</span>
            <span class="token class-name">String</span> latestRemoteRegions <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">fetchRegistryForRemoteRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> latestRemoteRegions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> currentRemoteRegions <span class="token operator">=</span> remoteRegionsToFetch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>latestRemoteRegions<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentRemoteRegions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Both remoteRegionsToFetch and AzToRegionMapper.regionsToFetch need to be in sync</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>instanceRegionChecker<span class="token punctuation">.</span><span class="token function">getAzToRegionMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>remoteRegionsToFetch<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>currentRemoteRegions<span class="token punctuation">,</span> latestRemoteRegions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> remoteRegions <span class="token operator">=</span> latestRemoteRegions<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            remoteRegionsRef<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>remoteRegions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            instanceRegionChecker<span class="token punctuation">.</span><span class="token function">getAzToRegionMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRegionsToFetch</span><span class="token punctuation">(</span>remoteRegions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            remoteRegionsModified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                                    <span class="token string">&quot;Remote regions to fetch modified concurrently,&quot;</span> <span class="token operator">+</span> <span class="token string">&quot; ignoring change from {} to {}&quot;</span><span class="token punctuation">,</span>
                                    currentRemoteRegions<span class="token punctuation">,</span> latestRemoteRegions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Just refresh mapping to reflect any DNS/Property change</span>
                    instanceRegionChecker<span class="token punctuation">.</span><span class="token function">getAzToRegionMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">refreshMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token function">fetchRegistry</span><span class="token punctuation">(</span>remoteRegionsModified<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                registrySize <span class="token operator">=</span> localRegionApps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lastSuccessfulRegistryFetchTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">StringBuilder</span> allAppsHashCodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Local region apps hashcode: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>localRegionApps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAppsHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;, is fetching remote regions? &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>isFetchingRemoteRegionRegistries<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Applications</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> remoteRegionVsApps<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;, Remote region: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; , apps hashcode: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allAppsHashCodes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAppsHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Completed cache refresh task for discovery. All Apps hash code is {} &quot;</span><span class="token punctuation">,</span> allAppsHashCodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot fetch registry from server&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fetchRegistry</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceFullRegistryFetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Stopwatch</span> tracer <span class="token operator">=</span> <span class="token constant">FETCH_REGISTRY_TIMER</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// If the delta is disabled or if it is the first time, get all</span>
            <span class="token comment">// applications</span>
            <span class="token class-name">Applications</span> applications <span class="token operator">=</span> <span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldDisableDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>
                    clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryRefreshSingleVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> forceFullRegistryFetch <span class="token operator">||</span> <span class="token punctuation">(</span>applications
                    <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getRegisteredApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Client application does not have latest library supporting delta</span>
            <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Disable delta property : {}&quot;</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">shouldDisableDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Single vip registry refresh property : {}&quot;</span><span class="token punctuation">,</span>
                        clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryRefreshSingleVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Force full registry fetch : {}&quot;</span><span class="token punctuation">,</span> forceFullRegistryFetch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application is null : {}&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>applications <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Registered Applications size is zero : {}&quot;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getRegisteredApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application version is -1: {}&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//TODO 全量拉取</span>
                <span class="token function">getAndStoreFullRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//TODO 增量拉取</span>
                <span class="token function">getAndUpdateDelta</span><span class="token punctuation">(</span>applications<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            applications<span class="token punctuation">.</span><span class="token function">setAppsHashCode</span><span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getReconcileHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">logTotalInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;{} - was unable to refresh its cache! status = {}&quot;</span><span class="token punctuation">,</span> appPathIdentifier<span class="token punctuation">,</span>
                    e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tracer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tracer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// Notify about cache refresh before updating the instance remote status</span>
        <span class="token function">onCacheRefreshed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Update remote status based on refreshed data held in the cache</span>
        <span class="token function">updateInstanceRemoteStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// registry was fetched successfully, so return true</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 全量拉取代码，拉取成功放入缓存</span>
    <span class="token comment">//localRegionApps.set(this.filterAndShuffle(apps));</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getAndStoreFullRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> currentUpdateGeneration <span class="token operator">=</span> fetchRegistryGeneration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Getting all instance registry info from the eureka server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Applications</span> apps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Applications</span><span class="token punctuation">&gt;</span></span> httpResponse <span class="token operator">=</span>
                clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryRefreshSingleVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> eurekaTransport<span class="token punctuation">.</span>queryClient<span class="token punctuation">.</span><span class="token function">getApplications</span><span class="token punctuation">(</span>
                        remoteRegionsRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">:</span> eurekaTransport<span class="token punctuation">.</span>queryClient<span class="token punctuation">.</span><span class="token function">getVip</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryRefreshSingleVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                remoteRegionsRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>httpResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            apps <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The response status is {}&quot;</span><span class="token punctuation">,</span> httpResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>apps <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;The application is null for some reason. Not storing this information&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchRegistryGeneration<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>currentUpdateGeneration<span class="token punctuation">,</span> currentUpdateGeneration <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            localRegionApps<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filterAndShuffle</span><span class="token punctuation">(</span>apps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Got full registry with apps hashcode {}&quot;</span><span class="token punctuation">,</span> apps<span class="token punctuation">.</span><span class="token function">getAppsHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Not updating applications as another thread is updating it already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>以上讲完eureka源码,总结一下
服务端启动暴露http服务,同时自己会同步其他eureka服务列表,如果需要注册到其他eureka也会注册,在收到客户端的请求后
会将注册实例写入到一个 二级map中
同时客户端来读取服务列表时,使用了3级缓存,readonlyMap,readwritemap,和服务注册列表map,这些map有定时任务会同步</p> <p>客户端这块,在启动的时候,会初始化DiscoveryClient 构造函数中会有注册和定时任务 服务列表拉取和心跳等事件,这里重点关注注册和服务列表拉取
服务列表拉取最终会在会初始化DiscoveryClient 缓存 AtomicReference<Applications> localRegionApps = new
AtomicReference<Applications>();</Applications></Applications></p> <p>最后看下服务关闭的时候怎么注销服务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 这里用到 @PreDestroy  在DiscoveryClient 销毁，因为时单例所以在容器销毁的时候在会调用shutdown</span>
<span class="token comment">//shutdown 调用 unregister 在调用 cancel 方法，发现时一个 http DELETE 请求uri 是apps/appName/id</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscoveryClient</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@PreDestroy</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isShutdown<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down DiscoveryClient ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statusChangeListener <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> applicationInfoManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                applicationInfoManager<span class="token punctuation">.</span><span class="token function">unregisterStatusChangeListener</span><span class="token punctuation">(</span>statusChangeListener<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token function">cancelScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// If APPINFO was registered</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationInfoManager <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> clientConfig<span class="token punctuation">.</span><span class="token function">shouldRegisterWithEureka</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> clientConfig<span class="token punctuation">.</span><span class="token function">shouldUnregisterOnShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                applicationInfoManager<span class="token punctuation">.</span><span class="token function">setInstanceStatus</span><span class="token punctuation">(</span><span class="token class-name">InstanceStatus</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">unregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eurekaTransport <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eurekaTransport<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            heartbeatStalenessMonitor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            registryStalenessMonitor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Completed shut down of DiscoveryClient&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * unregister w/ the eureka service.
     */</span>
    <span class="token keyword">void</span> <span class="token function">unregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// It can be null if shouldRegisterWithEureka == false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eurekaTransport <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> eurekaTransport<span class="token punctuation">.</span>registrationClient <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Unregistering ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> httpResponse <span class="token operator">=</span> eurekaTransport<span class="token punctuation">.</span>registrationClient<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>
                        instanceInfo<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;{} - deregister  status: {}&quot;</span><span class="token punctuation">,</span> appPathIdentifier<span class="token punctuation">,</span> httpResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;{} - de-registration failed{}&quot;</span><span class="token punctuation">,</span> appPathIdentifier<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token class-name">String</span> appName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> urlPath <span class="token operator">=</span> <span class="token string">&quot;apps/&quot;</span> <span class="token operator">+</span> appName <span class="token operator">+</span> <span class="token char">'/'</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">ClientResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Builder</span> resourceBuilder <span class="token operator">=</span> jerseyClient<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>serviceUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addExtraHeaders</span><span class="token punctuation">(</span>resourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response <span class="token operator">=</span> resourceBuilder<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">ClientResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">anEurekaHttpResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token function">headersOf</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Jersey HTTP DELETE {}/{}; statusCode={}&quot;</span><span class="token punctuation">,</span> serviceUrl<span class="token punctuation">,</span> urlPath<span class="token punctuation">,</span>
                        response <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;N/A&quot;</span> <span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此 eureka 源码分析完毕,学到了不少,不过仔细看看其实不难,自己实现一个也很简单</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/to-be-bast/frame/springcloud.html" class="prev">
        springCloud
      </a></span> <span class="next"><a href="/to-be-bast/frame/springcloud源码ribbon.html">
        springcloud源码ribbon
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/to-be-bast/assets/js/app.c3e67182.js" defer></script><script src="/to-be-bast/assets/js/2.a97ad3d5.js" defer></script><script src="/to-be-bast/assets/js/63.e40f2c54.js" defer></script>
  </body>
</html>
